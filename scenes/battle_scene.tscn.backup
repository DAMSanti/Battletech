[gd_scene load_steps=5 format=3 uid="uid://bquqshv3tglg8"]

[ext_resource type="Script" path="res://scripts/battle_scene.gd" id="1_battle"]
[ext_resource type="Script" path="res://scripts/hex_grid.gd" id="2_hexgrid"]
[ext_resource type="Script" path="res://scripts/managers/turn_manager.gd" id="3_turnmgr"]

[sub_resource type="GDScript" id="GDScript_ui"]
script/source = "extends CanvasLayer

@onready var battle_scene = get_parent()

var turn_label: Label
var phase_label: Label
var unit_info_label: Label
var end_turn_button: Button
var help_label: Label
var combat_log: RichTextLabel

# Elementos de animaci√≥n de dados
var dice_panel: Panel
var dice_labels: Array = []
var dice_result_labels: Array = []
var dice_winner_label: Label
var is_showing_initiative = false

func _ready():
	_setup_ui()
	# Esperar un frame para que battle_scene est√© listo
	await get_tree().process_frame
	if battle_scene:
		if battle_scene.turn_manager:
			battle_scene.turn_manager.turn_changed.connect(_on_turn_changed)
			battle_scene.turn_manager.phase_changed.connect(_on_phase_changed)
			battle_scene.turn_manager.unit_activated.connect(_on_unit_activated)

func _setup_ui():
	# Panel de informaci√≥n superior
	var info_panel = Panel.new()
	info_panel.position = Vector2(10, 10)
	info_panel.size = Vector2(400, 200)
	add_child(info_panel)
	
	var vbox = VBoxContainer.new()
	vbox.position = Vector2(15, 15)
	vbox.size = Vector2(370, 170)
	info_panel.add_child(vbox)
	
	turn_label = Label.new()
	turn_label.text = \"Turn: 1\"
	turn_label.add_theme_font_size_override(\"font_size\", 20)
	vbox.add_child(turn_label)
	
	phase_label = Label.new()
	phase_label.text = \"Phase: Movement\"
	phase_label.add_theme_font_size_override(\"font_size\", 18)
	phase_label.add_theme_color_override(\"font_color\", Color.CYAN)
	vbox.add_child(phase_label)
	
	unit_info_label = Label.new()
	unit_info_label.text = \"No unit selected\"
	unit_info_label.add_theme_font_size_override(\"font_size\", 14)
	vbox.add_child(unit_info_label)
	
	# Label de ayuda
	help_label = Label.new()
	help_label.text = \"\"
	help_label.add_theme_font_size_override(\"font_size\", 16)
	help_label.add_theme_color_override(\"font_color\", Color.YELLOW)
	help_label.autowrap_mode = TextServer.AUTOWRAP_WORD
	help_label.custom_minimum_size = Vector2(370, 40)
	vbox.add_child(help_label)
	
	# Bot√≥n de fin de turno
	end_turn_button = Button.new()
	end_turn_button.text = \"End Activation\"
	end_turn_button.position = Vector2(10, 220)
	end_turn_button.size = Vector2(200, 50)
	end_turn_button.add_theme_font_size_override(\"font_size\", 18)
	end_turn_button.pressed.connect(_on_end_turn_pressed)
	add_child(end_turn_button)
	
	# Log de combate
	var log_panel = Panel.new()
	log_panel.position = Vector2(10, 1600)
	log_panel.size = Vector2(1060, 300)
	add_child(log_panel)
	
	var log_title = Label.new()
	log_title.text = \"Combat Log:\"
	log_title.position = Vector2(15, 10)
	log_title.add_theme_font_size_override(\"font_size\", 16)
	log_panel.add_child(log_title)
	
	combat_log = RichTextLabel.new()
	combat_log.position = Vector2(15, 40)
	combat_log.size = Vector2(1030, 250)
	combat_log.bbcode_enabled = true
	combat_log.scroll_following = true
	log_panel.add_child(combat_log)
	
	_setup_dice_animation()

func _setup_dice_animation():
	# Panel de animaci√≥n de dados (oculto por defecto)
	dice_panel = Panel.new()
	dice_panel.position = Vector2(140, 400)
	dice_panel.size = Vector2(800, 500)
	dice_panel.visible = false
	
	var style = StyleBoxFlat.new()
	style.bg_color = Color(0.1, 0.1, 0.15, 0.95)
	style.corner_radius_top_left = 10
	style.corner_radius_top_right = 10
	style.corner_radius_bottom_left = 10
	style.corner_radius_bottom_right = 10
	style.border_width_all = 3
	style.border_color = Color.GOLD
	dice_panel.add_theme_stylebox_override(\"panel\", style)
	add_child(dice_panel)
	
	# T√≠tulo
	var title = Label.new()
	title.text = \"INITIATIVE ROLL\"
	title.position = Vector2(250, 20)
	title.add_theme_font_size_override(\"font_size\", 36)
	title.add_theme_color_override(\"font_color\", Color.GOLD)
	dice_panel.add_child(title)
	
	# PLAYER
	var player_title = Label.new()
	player_title.text = \"PLAYER\"
	player_title.position = Vector2(100, 80)
	player_title.add_theme_font_size_override(\"font_size\", 24)
	player_title.add_theme_color_override(\"font_color\", Color.CYAN)
	dice_panel.add_child(player_title)
	
	# Dados del jugador (2)
	for i in range(2):
		var dice_label = Label.new()
		dice_label.position = Vector2(50 + (i * 140), 120)
		dice_label.custom_minimum_size = Vector2(120, 120)
		dice_label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
		dice_label.vertical_alignment = VERTICAL_ALIGNMENT_CENTER
		dice_label.add_theme_font_size_override(\"font_size\", 72)
		dice_label.text = \"?\"
		
		# Panel con estilo para cada dado
		var dice_bg = Panel.new()
		dice_bg.position = dice_label.position
		dice_bg.custom_minimum_size = Vector2(120, 120)
		var dice_style = StyleBoxFlat.new()
		dice_style.bg_color = Color.WHITE
		dice_style.corner_radius_top_left = 15
		dice_style.corner_radius_top_right = 15
		dice_style.corner_radius_bottom_left = 15
		dice_style.corner_radius_bottom_right = 15
		dice_style.border_width_all = 5
		dice_style.border_color = Color(0.3, 0.3, 0.3)
		dice_style.shadow_color = Color(0, 0, 0, 0.5)
		dice_style.shadow_size = 10
		dice_bg.add_theme_stylebox_override(\"panel\", dice_style)
		dice_panel.add_child(dice_bg)
		
		dice_label.add_theme_color_override(\"font_color\", Color.BLACK)
		dice_panel.add_child(dice_label)
		dice_labels.append(dice_label)
	
	# Resultado jugador
	var player_result = Label.new()
	player_result.position = Vector2(70, 260)
	player_result.add_theme_font_size_override(\"font_size\", 32)
	player_result.add_theme_color_override(\"font_color\", Color.CYAN)
	player_result.text = \"Total: ?\"
	dice_panel.add_child(player_result)
	dice_result_labels.append(player_result)
	
	# ENEMY
	var enemy_title = Label.new()
	enemy_title.text = \"ENEMY\"
	enemy_title.position = Vector2(530, 80)
	enemy_title.add_theme_font_size_override(\"font_size\", 24)
	enemy_title.add_theme_color_override(\"font_color\", Color.RED)
	dice_panel.add_child(enemy_title)
	
	# Dados del enemigo (2)
	for i in range(2):
		var dice_label = Label.new()
		dice_label.position = Vector2(480 + (i * 140), 120)
		dice_label.custom_minimum_size = Vector2(120, 120)
		dice_label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
		dice_label.vertical_alignment = VERTICAL_ALIGNMENT_CENTER
		dice_label.add_theme_font_size_override(\"font_size\", 72)
		dice_label.text = \"?\"
		
		# Panel con estilo para cada dado
		var dice_bg = Panel.new()
		dice_bg.position = dice_label.position
		dice_bg.custom_minimum_size = Vector2(120, 120)
		var dice_style = StyleBoxFlat.new()
		dice_style.bg_color = Color.WHITE
		dice_style.corner_radius_top_left = 15
		dice_style.corner_radius_top_right = 15
		dice_style.corner_radius_bottom_left = 15
		dice_style.corner_radius_bottom_right = 15
		dice_style.border_width_all = 5
		dice_style.border_color = Color(0.3, 0.3, 0.3)
		dice_style.shadow_color = Color(0, 0, 0, 0.5)
		dice_style.shadow_size = 10
		dice_bg.add_theme_stylebox_override(\"panel\", dice_style)
		dice_panel.add_child(dice_bg)
		
		dice_label.add_theme_color_override(\"font_color\", Color.BLACK)
		dice_panel.add_child(dice_label)
		dice_labels.append(dice_label)
	
	# Resultado enemigo
	var enemy_result = Label.new()
	enemy_result.position = Vector2(500, 260)
	enemy_result.add_theme_font_size_override(\"font_size\", 32)
	enemy_result.add_theme_color_override(\"font_color\", Color.RED)
	enemy_result.text = \"Total: ?\"
	dice_panel.add_child(enemy_result)
	dice_result_labels.append(enemy_result)
	
	# Winner label
	dice_winner_label = Label.new()
	dice_winner_label.position = Vector2(200, 350)
	dice_winner_label.add_theme_font_size_override(\"font_size\", 48)
	dice_winner_label.text = \"\"
	dice_panel.add_child(dice_winner_label)

func update_turn_info(turn: int, team: String):
	turn_label.text = \"Turn: %d (%s)\" % [turn, team]

func update_phase_info(phase: String):
	phase_label.text = \"Phase: \" + phase
	
	# Actualizar texto de ayuda seg√∫n la fase
	match phase:
		\"INITIATIVE\":
			help_label.text = \"Rolling initiative...\"
			phase_label.add_theme_color_override(\"font_color\", Color.GOLD)
		\"MOVEMENT\":
			help_label.text = \"Click BLUE hexes to move your mech\"
			phase_label.add_theme_color_override(\"font_color\", Color.CYAN)
		\"WEAPON_ATTACK\":
			help_label.text = \"Click RED enemy mechs to attack\"
			phase_label.add_theme_color_override(\"font_color\", Color.ORANGE)
		\"PHYSICAL_ATTACK\":
			help_label.text = \"Click MAGENTA enemies for physical attack\"
			phase_label.add_theme_color_override(\"font_color\", Color.MAGENTA)
		\"HEAT\":
			help_label.text = \"Dissipating heat...\"
			phase_label.add_theme_color_override(\"font_color\", Color.ORANGE_RED)
		_:
			help_label.text = \"\"

func update_unit_info(unit):
	print(\"UI: update_unit_info called with unit: \", unit)
	
	if unit == null:
		unit_info_label.text = \"No unit selected\"
		return
	
	var info = \"%s\\n\" % unit.mech_name
	info += \"Pilot: %s\\n\" % unit.pilot_name
	info += \"Heat: %d/%d\\n\" % [unit.heat, unit.heat_capacity]
	info += \"Movement: %d/%d\\n\" % [unit.current_movement, unit.movement_points]
	
	# Calcular armadura total
	var total_armor = 0
	var current_armor = 0
	for loc in unit.armor.keys():
		total_armor += unit.armor[loc][\"max\"]
		current_armor += unit.armor[loc][\"current\"]
	
	var armor_percent = int((float(current_armor) / float(total_armor)) * 100)
	info += \"Armor: %d%%\" % armor_percent
	
	unit_info_label.text = info
	print(\"UI: unit_info_label updated to: \", info)

func add_combat_message(message: String, color: Color = Color.WHITE):
	var color_hex = color.to_html()
	# Convertir [] en emojis de dados para mejor visualizaci√≥n
	var formatted_message = message
	if \"[\" in message and \"]\" in message:
		# Reemplazar dados con s√≠mbolos
		formatted_message = message.replace(\"[\", \"üé≤\").replace(\"]\", \"\")
	combat_log.append_text(\"[color=#%s]%s[/color]\\n\" % [color_hex, formatted_message])

func _on_end_turn_pressed():
	if battle_scene and battle_scene.turn_manager:
		# Solo permitir si es turno del jugador
		if battle_scene.selected_unit and battle_scene.selected_unit in battle_scene.player_mechs:
			battle_scene.turn_manager.complete_unit_activation()
			add_combat_message(\"Activation ended\", Color.GRAY)

func _on_turn_changed(team: String, turn: int):
	update_turn_info(turn, team)

func _on_phase_changed(phase: String):
	update_phase_info(phase)

func _on_unit_activated(unit):
	update_unit_info(unit)

func show_initiative_animation(data: Dictionary):
	if is_showing_initiative:
		return
	
	is_showing_initiative = true
	dice_panel.visible = true
	dice_panel.modulate = Color(1, 1, 1, 0)
	
	# Fade in del panel
	var fade_in = create_tween()
	fade_in.tween_property(dice_panel, \"modulate\", Color.WHITE, 0.3)
	await fade_in.finished
	
	# Animar dados
	var dice_faces = [\"‚öÄ\", \"‚öÅ\", \"‚öÇ\", \"‚öÉ\", \"‚öÑ\", \"‚öÖ\"]
	
	# Roleo de dados
	for frame in range(30):  # 30 frames de animaci√≥n
		for i in range(4):
			var random_face = randi() % 6
			dice_labels[i].text = dice_faces[random_face]
		await get_tree().create_timer(0.05).timeout
	
	# Mostrar resultados finales
	dice_labels[0].text = dice_faces[data[\"player_dice\"][0] - 1]
	dice_labels[1].text = dice_faces[data[\"player_dice\"][1] - 1]
	dice_labels[2].text = dice_faces[data[\"enemy_dice\"][0] - 1]
	dice_labels[3].text = dice_faces[data[\"enemy_dice\"][1] - 1]
	
	# Bounce effect en resultados
	for label in dice_labels:
		label.scale = Vector2(1.3, 1.3)
		var bounce = create_tween()
		bounce.tween_property(label, \"scale\", Vector2(1.0, 1.0), 0.3).set_trans(Tween.TRANS_ELASTIC).set_ease(Tween.EASE_OUT)
	
	await get_tree().create_timer(0.5).timeout
	
	# Mostrar totales
	dice_result_labels[0].text = \"Total: %d\" % data[\"player_total\"]
	dice_result_labels[1].text = \"Total: %d\" % data[\"enemy_total\"]
	
	await get_tree().create_timer(0.5).timeout
	
	# Mostrar ganador
	if data[\"winner\"] == \"player\":
		dice_winner_label.text = \"‚òÖ PLAYER WINS! ‚òÖ\"
		dice_winner_label.add_theme_color_override(\"font_color\", Color.GREEN)
	else:
		dice_winner_label.text = \"‚òÖ ENEMY WINS! ‚òÖ\"
		dice_winner_label.add_theme_color_override(\"font_color\", Color.ORANGE_RED)
	
	dice_winner_label.modulate = Color(1, 1, 1, 0)
	var winner_fade = create_tween()
	winner_fade.tween_property(dice_winner_label, \"modulate\", Color.WHITE, 0.5)
	
	await get_tree().create_timer(2.0).timeout
	
	# Fade out
	var fade_out = create_tween()
	fade_out.tween_property(dice_panel, \"modulate\", Color(1, 1, 1, 0), 0.5)
	await fade_out.finished
	
	dice_panel.visible = false
	dice_panel.modulate = Color.WHITE
	dice_winner_label.text = \"\"
	is_showing_initiative = false

var physical_menu_panel = null
var current_physical_target = null

func show_physical_attack_options(attacker, target):
	current_physical_target = target
	
	# Crear panel de opciones si no existe
	if physical_menu_panel == null:
		physical_menu_panel = Panel.new()
		physical_menu_panel.position = Vector2(450, 300)
		physical_menu_panel.size = Vector2(300, 350)
		add_child(physical_menu_panel)
		
		var title = Label.new()
		title.text = \"Physical Attack Options:\"
		title.position = Vector2(10, 10)
		title.add_theme_font_size_override(\"font_size\", 18)
		physical_menu_panel.add_child(title)
		
		var vbox = VBoxContainer.new()
		vbox.position = Vector2(10, 50)
		vbox.add_theme_constant_override(\"separation\", 10)
		physical_menu_panel.add_child(vbox)
		
		# Bot√≥n Pu√±etazo Izquierdo
		var punch_left_btn = Button.new()
		punch_left_btn.text = \"Punch (Left Arm)\"
		punch_left_btn.custom_minimum_size = Vector2(280, 50)
		punch_left_btn.pressed.connect(_on_physical_attack_selected.bind(\"punch_left\"))
		vbox.add_child(punch_left_btn)
		
		# Bot√≥n Pu√±etazo Derecho
		var punch_right_btn = Button.new()
		punch_right_btn.text = \"Punch (Right Arm)\"
		punch_right_btn.custom_minimum_size = Vector2(280, 50)
		punch_right_btn.pressed.connect(_on_physical_attack_selected.bind(\"punch_right\"))
		vbox.add_child(punch_right_btn)
		
		# Bot√≥n Patada
		var kick_btn = Button.new()
		kick_btn.text = \"Kick\"
		kick_btn.custom_minimum_size = Vector2(280, 50)
		kick_btn.pressed.connect(_on_physical_attack_selected.bind(\"kick\"))
		vbox.add_child(kick_btn)
		
		# Bot√≥n Empujar
		var push_btn = Button.new()
		push_btn.text = \"Push\"
		push_btn.custom_minimum_size = Vector2(280, 50)
		push_btn.pressed.connect(_on_physical_attack_selected.bind(\"push\"))
		vbox.add_child(push_btn)
		
		# Bot√≥n Cancelar
		var cancel_btn = Button.new()
		cancel_btn.text = \"Cancel\"
		cancel_btn.custom_minimum_size = Vector2(280, 50)
		cancel_btn.pressed.connect(hide_physical_attack_options)
		vbox.add_child(cancel_btn)
	
	physical_menu_panel.visible = true

func hide_physical_attack_options():
	if physical_menu_panel:
		physical_menu_panel.visible = false
	current_physical_target = null

func _on_physical_attack_selected(attack_type: String):
	if battle_scene and current_physical_target:
		battle_scene._perform_physical_attack(battle_scene.selected_unit, current_physical_target, attack_type)
	hide_physical_attack_options()
"

[node name="BattleScene" type="Node2D"]
script = ExtResource("1_battle")

[node name="HexGrid" type="Node2D" parent="."]
position = Vector2(100, 200)
script = ExtResource("2_hexgrid")

[node name="TurnManager" type="Node" parent="."]
script = ExtResource("3_turnmgr")

[node name="UI" type="CanvasLayer" parent="."]
script = SubResource("GDScript_ui")

[node name="Camera2D" type="Camera2D" parent="."]
position = Vector2(540, 960)
